<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="tabs"></ion-back-button>
    </ion-buttons>
    <ion-title>
      <h2>
        Registro de Chamada
      </h2>
      <h6>
        {{lessonDate | date: 'dd/MM/yyyy'}}
      </h6>
    </ion-title>
  </ion-toolbar>
</ion-header>
<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Registro de Chamada<</ion-title>
    </ion-toolbar>
  </ion-header>
  
  <ng-container *ngIf="{ ebdPresencesRegister: ebdPresencesRegister$ | async, ebdLabels: ebdLabels$ | async } as values">
    <ion-list>
      <ion-item lines="full">
        <ion-label class="ion-text-wrap" style="margin-bottom: 0px;">
          <h2><strong>Classe {{className}}</strong></h2>
          <h3 style="font-weight: 400;">{{lessonTitle}}</h3>
          <h3>{{values?.ebdPresencesRegister | studentsCount}} alunos nessa chamada</h3>
          <div style="display: flex; align-items: center;">
            <h3 style="margin-right: 8px;">{{visitorsQuantity}} {{visitorsQuantity === 1 ? 'visitante' : 'visitantes'}}</h3>
            <ion-button size="small" color="dark" fill="clear" (click)="visitorsQuantity = visitorsQuantity + 1">
              <ion-icon slot="icon-only" name="add-circle-outline"></ion-icon>
            </ion-button>
            <ion-button size="small" color="dark" fill="clear" (click)="visitorsQuantity = visitorsQuantity - 1" [disabled]="!visitorsQuantity">
              <ion-icon slot="icon-only" name="remove-circle-outline"></ion-icon>
            </ion-button>
          </div>
        </ion-label>
      </ion-item>

      <ng-container *ngIf="values?.ebdPresencesRegister?.length; else loadingTemplate">
        <ion-accordion-group [multiple]="false" animated="true">
          <ion-accordion *ngFor="let presenceRegister of values?.ebdPresencesRegister; let index = index" class="ion-accordion" id="accordion-{{presenceRegister?.id}}" value="accordion-{{presenceRegister?.id}}">
            <ion-item slot="header" lines="none">
              <ion-label class="ion-text-wrap">
                <ng-container *ngIf="presenceRegister['is_teacher'] || presenceRegister['is_secretary']; else ebdRelationTemplate">
                  <ion-text *ngIf="presenceRegister['is_teacher']" color="highlight">
                    <h4>Professor</h4>
                  </ion-text>
                  <ion-text *ngIf="presenceRegister['is_secretary']" color="warning">
                    <h4>Secretário</h4>
                  </ion-text>
                </ng-container>
                <ng-template #ebdRelationTemplate>
                  <ion-text *ngIf="presenceRegister['person_ebd_relation']" color="{{presenceRegister['person_ebd_relation'] === 'visitante' ? 'secondary' : 'dark'}}">
                    <h4>{{presenceRegister['person_ebd_relation'] | titlecase}}</h4>
                  </ion-text>
                </ng-template>
                <h2>{{presenceRegister['person_name']}}</h2>
                <h5 *ngIf="!presenceRegister?.underAction && (presenceRegister['register_on'] || presenceRegister['tempRegisterOn'])">
                  <span *ngIf="presenceRegister?.attended">Chegou às {{(presenceRegister['register_on'] || presenceRegister['tempRegisterOn']) | date: 'HH:mm'}}</span>
                  <span *ngIf="!presenceRegister?.attended">Recebeu falta em {{(presenceRegister['register_on'] || presenceRegister['tempRegisterOn']) | date: 'dd/MM/yyyy HH:mm'}}</span>
                </h5>
                <ion-text *ngIf="presenceRegister?.tempRegisterOn && !presenceRegister?.register_on" color="primary" style="font-weight: bold; text-shadow: 2px 2px 5px var(--ion-color-warning);">
                  <h5>Não esqueça de Salvar</h5>
                </ion-text>
              </ion-label>
              <ion-button class="button-large" style="margin-right: 5px;" color="success" size="default" [fill]="presenceRegister?.attended && (presenceRegister?.register_on || presenceRegister?.tempRegisterOn) ? 'solid' : 'clear'" (click)="givePresence(presenceRegister); $event.stopPropagation()" [disabled]="presenceRegister?.underAction">
                <ion-icon slot="icon-only" name="checkmark-circle-outline"></ion-icon>
              </ion-button>
              <ion-button class="button-large" style="margin-left: 5px;" color="danger" size="default" [fill]="!presenceRegister?.attended && (presenceRegister?.register_on || presenceRegister?.tempRegisterOn) ? 'solid' : 'clear'" (click)="giveAbsence(presenceRegister); $event.stopPropagation()" [disabled]="presenceRegister?.underAction">
                <ion-icon slot="icon-only" name="close-circle-outline"></ion-icon>
              </ion-button>
            </ion-item>
    
            <ion-list slot="content" lines="full">
              <ion-item lines="none" [disabled]="presenceRegister['is_teacher'] || presenceRegister['is_secretary']">
                <ion-label class="ion-text-wrap">
                  <ion-chip *ngFor="let label of values?.ebdLabels" style="height: auto;" [color]="label?.type === 'positive' ? 'success' : 'danger'" [outline]="!presenceRegister?.labelIds?.includes(label?.id)" [style]="label?.type === 'positive' ? (presenceRegister?.labelIds?.includes(label?.id) ? 'background: var(--ion-color-success); color: var(--ion-color-light)' : '') : (presenceRegister?.labelIds?.includes(label?.id) ? 'background: var(--ion-color-danger); color: var(--ion-color-light)' : '')" (click)="giveCharacteristic(presenceRegister, label)" [disabled]="presenceRegister?.underAction">
                    <ion-icon [name]="label?.type === 'positive' ? 'thumbs-up-outline' : 'thumbs-down-outline'"></ion-icon>
                    <ion-label>{{label?.title}}</ion-label>
                  </ion-chip>
                </ion-label>
              </ion-item>
    
              <ion-button class="button-large" (click)="handleSavePresenceRegister(presenceRegister)" expand="full" fill="solid" [disabled]="presenceRegister?.underAction || (!presenceRegister?.register_on && !presenceRegister?.tempRegisterOn)">
                Salvar
              </ion-button>
            </ion-list>
          </ion-accordion>
        </ion-accordion-group>
      </ng-container>

      <ng-template #loadingTemplate>
        <ion-progress-bar type="indeterminate"></ion-progress-bar>
      </ng-template>
    </ion-list>
  </ng-container>
</ion-content>
